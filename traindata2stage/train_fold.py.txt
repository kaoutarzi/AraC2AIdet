import torch
import pandas as pd
from transformers import AutoTokenizer, AutoModelForSequenceClassification, Trainer, TrainingArguments
from datasets import concatenate_datasets
from preprocessing import load_and_preprocess
from metrics import compute_metrics

def tokenize_batch(batch, tokenizer):
    return tokenizer(batch["text"], padding="max_length", truncation=True, max_length=128)

def train_5fold(model_name, fold_paths, output_csv):
    # Load folds
    folds = [load_and_preprocess(path) for path in fold_paths]
    tokenizer = AutoTokenizer.from_pretrained(model_name)

    all_predictions = []

    for i in range(5):
        test_set = folds[i]
        train_sets = [folds[j] for j in range(5) if j != i]
        train_set = concatenate_datasets(train_sets)

        train_set = train_set.map(lambda x: tokenize_batch(x, tokenizer), batched=True)
        test_set = test_set.map(lambda x: tokenize_batch(x, tokenizer), batched=True)

        model = AutoModelForSequenceClassification.from_pretrained(model_name, num_labels=2)

        training_args = TrainingArguments(
            output_dir="./results",
            num_train_epochs=3,
            per_device_train_batch_size=16,
            per_device_eval_batch_size=32,
            save_strategy="epoch",
            learning_rate=2e-5,
            logging_dir="./logs",
            load_best_model_at_end=False,
            metric_for_best_model="f1",
            save_total_limit=2,
            fp16=True,
            report_to="none"
        )

        trainer = Trainer(
            model=model,
            args=training_args,
            train_dataset=train_set,
            eval_dataset=test_set,
            compute_metrics=compute_metrics
        )

        trainer.train()

        # Predictions
        raw_preds = trainer.predict(test_set)
        probs = torch.softmax(torch.tensor(raw_preds.predictions), dim=-1).numpy()

        fold_df = pd.DataFrame({
            model_name.split("/")[-1]: list(probs[:,1]),
            "class": ["human" if l==0 else "machine" for l in test_set["labels"]]
        })

        all_predictions.append(fold_df)
        print(f"Finished Fold {i+1}")

    final_df = pd.concat(all_predictions, ignore_index=True)
    final_df.to_csv(output_csv, index=False)
    print(f"Predictions saved in {output_csv}")
