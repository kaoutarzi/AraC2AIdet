import torch
import pandas as pd
from transformers import AutoTokenizer, AutoModelForSequenceClassification

def predict_dataset(model_key, df, text_col, label_col, suffix):
    tokenizer = AutoTokenizer.from_pretrained(f"saved_models/{model_key}")
    model = AutoModelForSequenceClassification.from_pretrained(f"saved_models/{model_key}")
    model.eval()

    tokens = tokenizer(
        df[text_col].tolist(),
        padding=True,
        truncation=True,
        max_length=128,
        return_tensors="pt"
    )

    probs = []
    with torch.no_grad():
        for i in range(0, len(df), 32):
            batch = {k: v[i:i+32] for k, v in tokens.items()}
            logits = model(**batch).logits
            probs.extend(torch.softmax(logits, dim=1)[:, 1].tolist())

    out = pd.DataFrame({
        f"{model_key}_proba": probs,
        "label": df[label_col]
    })

    out.to_csv(f"results/predictions/{model_key}_{suffix}.csv", index=False)
